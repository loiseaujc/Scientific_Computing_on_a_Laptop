
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Implementation based on nested for loops &#8212; Scientific computing on a Laptop</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.e8f53015daec13862f6db5e763c41738.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Vectorized implementation" href="vectorized.html" />
    <link rel="prev" title="Computing the pairwise interactions" href="pairwise_distance.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Scientific computing on a Laptop</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Cover.html">
   Scientific Computing on a Laptop
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Front Matter
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../FrontMatter/acknowledgements.html">
   Acknowledgements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../FrontMatter/table_of_content.html">
   Table of Contents
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  About this book
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../About/about.html">
   What is this book?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../About/what_do_i_need.html">
   What do I need?
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  The Holy Trinity
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Quick_Tours/Overview.html">
   Overview
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Large-scale linear algebra
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Linalg/Overview.html">
   Overview
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Applications in Physics
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Overview.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="NBody.html">
   N-Body simulations
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="formulation.html">
     General formulation
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="pairwise_distance.html">
     Computing the pairwise interactions
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Implementation based on nested
       <code class="docutils literal notranslate">
        <span class="pre">
         for
        </span>
       </code>
       loops
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="vectorized.html">
       Vectorized implementation
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="simulation.html">
     Full code for an N-Body simulation
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Applications in Maths
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Maths/Overview.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../Maths/Mandelbrot/Mandelbrot.html">
   Mandelbrot set
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Maths/Mandelbrot/definition.html">
     Definition of the Mandelbrot set
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Maths/Mandelbrot/binary_mandelbrot.html">
     Simple visualizations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Maths/Mandelbrot/buddhabrot.html">
     The Buddhabrot
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Applications in Biology
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Biology/Overview.html">
   Overview
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Applications in Mechanics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Mechanics/Overview.html">
   Overview
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../../_sources/Physics/NBody/naive.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/Physics/NBody/naive.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/executablebooks/jupyter-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FPhysics/NBody/naive.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/Physics/NBody/naive.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="implementation-based-on-nested-for-loops">
<h1>Implementation based on nested <code class="docutils literal notranslate"><span class="pre">for</span></code> loops<a class="headerlink" href="#implementation-based-on-nested-for-loops" title="Permalink to this headline">¶</a></h1>
<p>Let us start with the implementation students are most likely to come up with.
As usual, this implementation often involves nested <code class="docutils literal notranslate"><span class="pre">for</span></code> loops and possibly redundant computations.
We’ll assume that <code class="docutils literal notranslate"><span class="pre">numpy</span></code> has already been imported as <code class="docutils literal notranslate"><span class="pre">np</span></code>.
Such a naïve implementation is shown below.</p>
<p><strong><center>Algorithm 1a: Nested <code class="docutils literal notranslate"><span class="pre">for</span></code> loops</center></strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pairwise_interactions</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>

    <span class="c1"># --&gt; Number of particles.</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># --&gt; Initialize the force array.</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># --&gt; Loop through all the particles.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="c1"># --&gt; Compute the difference vector.</span>
            <span class="n">Δx</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
            <span class="c1"># --&gt; Add the ij contribution to the net force.</span>
            <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Δx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Δx</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
            
    <span class="k">return</span> <span class="n">F</span>
</pre></div>
</div>
</div>
</div>
<p>The code is self-explanatory.
It loops through each particle.
For each particle, it then compute the signed distance vector with respect to all the other particles and add the resulting gravitational attraction to the net force experienced by the i<sup>th</sup> particle.
Pretty simple.
Let us now benchmark this implementation.
For that purpose, we’ll consider 500 particles with random initial positions and velocities in <span class="math notranslate nohighlight">\(\mathbb{R}^3\)</span>.
The <code class="docutils literal notranslate"><span class="pre">%%timeit</span></code> magic is a useful command to know for that.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --&gt; Generate particles with random initial positions.</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">pairwise_interactions</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.36 s ± 148 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>On my laptop, this computation takes a bit more than 2 seconds.
An actual simulation may requires thousands if not millions of time steps, with each time step necessitating the evaluation of these pairwise interactions.
Despite its simplicity, there is no way than one could simulate even a moderately large number of particles in a reasonnable time using this code snippet.</p>
<p>Even though the code is slow, it can run twice as fast by leveraging existing symmetries in the equations.
You can easily convince yourself that</p>
<div class="math notranslate nohighlight">
\[
\mathbf{F}_{ij} = -\mathbf{F}_{ji}.
\]</div>
<p>Hence, the inner loop in <strong>Algorithm 1a</strong> does not need to run from <code class="docutils literal notranslate"><span class="pre">j=0</span></code> to <code class="docutils literal notranslate"><span class="pre">i=n-1</span></code> but only from <code class="docutils literal notranslate"><span class="pre">j=i+1</span></code> to <code class="docutils literal notranslate"><span class="pre">j=n-1</span></code>.
As soon as the contribution <span class="math notranslate nohighlight">\(\mathbf{F}_{ij}\)</span> has been computed, <span class="math notranslate nohighlight">\(\mathbf{F}_{ji}\)</span> comes for free.
The corresponding code is shown below.</p>
<p><strong><center>Algorithm 1b: Revisiting nested <code class="docutils literal notranslate"><span class="pre">for</span></code> loops</center></strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pairwise_interactions</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>

    <span class="c1"># --&gt; Number of particles.</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># --&gt; Initialize the force array.</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># --&gt; Loop through all the particles.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                
            <span class="c1"># --&gt; Compute the difference vector.</span>
            <span class="n">Δx</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
            <span class="c1"># --&gt; Add the ij contribution to the net force.</span>
            <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Δx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Δx</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
            
            <span class="c1"># --&gt; Add the ji contribution to the net force.</span>
            <span class="n">F</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
    <span class="k">return</span> <span class="n">F</span>
</pre></div>
</div>
</div>
</div>
<p>Let us once again benchmark this implementation using the same 500 particles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">pairwise_interactions</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.28 s ± 29.5 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>As expected, the computational time is roughly divided by 2.
Yet, the code is still extremely slow and cannot be realistically used in a production run.
The primary reason for this slowness is the use of <code class="docutils literal notranslate"><span class="pre">for</span></code> loops.
Such loops are incredibly slow in Python compared to other compiled languages as Fortran or C.
There are technical reasons for why <code class="docutils literal notranslate"><span class="pre">for</span></code> loops are slow in Python but discussing these would bring us down the rabbit hole.
For now, you only need to remember that, when its comes to scientific computing, <code class="docutils literal notranslate"><span class="pre">for</span></code> loops in Python need to be avoided like the plague.</p>
<p>In many cases, <code class="docutils literal notranslate"><span class="pre">for</span></code> loops can be avoided by taking a step back from code and reframing the problem slightly differently.
This will be illustrated in the next section where we’ll use some neat <code class="docutils literal notranslate"><span class="pre">numpy</span></code> tricks such as <strong>vectorization</strong> and <strong>broadcasting</strong>.
It may happen however that getting rid of <code class="docutils literal notranslate"><span class="pre">for</span></code> loops is not possible.
It could also severely reduce the code readability or simply not be obvious at all.</p>
<a class="reference internal image-reference" href="https://numba.pydata.org/_static/numba-blue-horizontal-rgb.svg"><img alt="https://numba.pydata.org/_static/numba-blue-horizontal-rgb.svg" class="align-left" src="https://numba.pydata.org/_static/numba-blue-horizontal-rgb.svg" width="192px" /></a>
<p>In these cases, Python’s scientific computing ecosystem has a few extremely useful packages.
One of them is <a class="reference external" href="https://numba.pydata.org/"><strong>Numba</strong></a>, an open source <em>just-in-time</em> compiler that can translate a subset of Python or NumPy code into fast machine code.
From Numba’s website</p>
<blockquote>
<div><p>Numba translates Python functions to optimized machine code at runtime using the industry-standard <a class="reference external" href="https://llvm.org/">LLVM</a> compiler library. Numba-compiled numerical algorithms in Python can approach the speeds of C or Fortran.</p>
</div></blockquote>
<p>What Numba does basically is to take your naïve Python implementation and generates on-the-fly specialized machine code for different array data types and layouts to optimize performance.</p>
<div class="danger admonition">
<p class="admonition-title">Be careful though…</p>
<p>At first, Numba may seem kind of magic and you may be tempted to use it on all your different pieces of code.
It may not however bring the speed-up you expected it would!
For more details about when to use or not Numba JIT capabilities, please read <a class="reference external" href="https://numba.readthedocs.io/en/stable/user/5minguide.html">Numba’s documentation</a>.</p>
</div>
<p>Despite what we’ve just said, our function <code class="docutils literal notranslate"><span class="pre">pairwise_interactions</span></code> is luckily an excellent candidate to illustrate the massive speed-up Numba can bring.
After having imported <code class="docutils literal notranslate"><span class="pre">numba</span></code>, using its JIT capabilities is as simple as adding the decorator <code class="docutils literal notranslate"><span class="pre">&#64;numba.jit()</span></code> to your function.
This is illustrated below.</p>
<p><strong><center>Algorithm 1c: Numba + nested <code class="docutils literal notranslate"><span class="pre">for</span></code> loops</center></strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numba</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pairwise_interactions</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>

    <span class="c1"># --&gt; Number of particles.</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># --&gt; Initialize the force array.</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># --&gt; Loop through all the particles.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                
            <span class="c1"># --&gt; Compute the difference vector.</span>
            <span class="n">Δx</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
            <span class="c1"># --&gt; Add the ij contribution to the net force.</span>
            <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Δx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Δx</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
            
            <span class="c1"># --&gt; Add the ji contribution to the net force.</span>
            <span class="n">F</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
    <span class="k">return</span> <span class="n">F</span>
</pre></div>
</div>
</div>
</div>
<p>As you can see, nothing has changed in the implementation of <code class="docutils literal notranslate"><span class="pre">pairwise_interactions</span></code>.
We simply added a decorator to it.
Let’s now see how it behaves using the same set of 500 particles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">pairwise_interactions</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>68.3 ms ± 42.1 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>Suddenly, the execution time went from close to 2 seconds down to less than 100 ms!
This is a 20x to 25x speed-up and it only required adding a single line of code.
As we’ll see, we can do even better.
Yet, this massive performance boost can sometime be sufficient to use this code in a production run.
It certainly is the case for most demonstration codes intended for students.</p>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Physics/NBody"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="pairwise_distance.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Computing the pairwise interactions</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="vectorized.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Vectorized implementation</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Jean-Christophe Loiseau<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>