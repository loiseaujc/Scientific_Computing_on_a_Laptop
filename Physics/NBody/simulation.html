
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Full code for an N-Body simulation &#8212; Scientific computing on a Laptop</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Applications in Maths" href="../../Maths/Overview.html" />
    <link rel="prev" title="Vectorized implementation" href="vectorized.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Scientific computing on a Laptop</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../Cover.html">
                    Scientific Computing on a Laptop
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Front Matter
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../FrontMatter/acknowledgements.html">
   Acknowledgements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../FrontMatter/table_of_content.html">
   Table of Contents
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  About this book
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../About/about.html">
   What is this book?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../About/what_do_i_need.html">
   What do I need?
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  The Holy Trinity
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Quick_Tours/Overview.html">
   Overview
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Large-scale linear algebra
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Linalg/Overview.html">
   Overview
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Partial Differential Equations
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../PDE/Overview.html">
   Overview
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Classical Physics
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Overview.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="NBody.html">
   N-Body simulations
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="formulation.html">
     General formulation
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="pairwise_distance.html">
     Computing the pairwise interactions
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="naive.html">
       Implementation based on nested
       <code class="docutils literal notranslate">
        <span class="pre">
         for
        </span>
       </code>
       loops
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="vectorized.html">
       Vectorized implementation
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Full code for an N-Body simulation
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Mathematicss
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Maths/Overview.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../Maths/Mandelbrot/Mandelbrot.html">
   Mandelbrot set
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Maths/Mandelbrot/definition.html">
     Definition of the Mandelbrot set
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Maths/Mandelbrot/binary_mandelbrot.html">
     Simple visualizations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Maths/Mandelbrot/buddhabrot.html">
     The Buddhabrot
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/Physics/NBody/simulation.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/executablebooks/jupyter-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FPhysics/NBody/simulation.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/Physics/NBody/simulation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download notebook file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        <a href="../../_sources/Physics/NBody/simulation.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#project-ideas-to-go-further">
   Project ideas to go further
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Full code for an N-Body simulation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#project-ideas-to-go-further">
   Project ideas to go further
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="full-code-for-an-n-body-simulation">
<h1>Full code for an N-Body simulation<a class="headerlink" href="#full-code-for-an-n-body-simulation" title="Permalink to this headline">#</a></h1>
<p>We now have every thing we need to implement a fairly efficient N-Body solver.
For the sake of simplicity, the equations of motions will be integrated forward in time using the <code class="docutils literal notranslate"><span class="pre">solve_ivp</span></code> function from <code class="docutils literal notranslate"><span class="pre">scipy.integrate</span></code>.
It gives access to fairly standard yet efficient time-integrators (e.g. high-order Runge-Kutta schemes).
Note that, for the problem we consider, energy-preserving schemes (e.g. symplectic time-integrators) might be better.
It however requires other packages that we won’t cover herein.
If you want to know more, you can check for instance <a class="reference external" href="https://github.com/SciML/diffeqpy">diffeqpy</a>, a Python wrapper for the incredible Julia package <a class="reference external" href="https://diffeq.sciml.ai/dev">DifferentialEquations.jl</a> providing such symplectic integrators.</p>
<p><strong><center> N-Body simulator using only NumPy and SciPy</center></strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --&gt; Import needed packages/functions.</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">solve_ivp</span>

<span class="k">def</span> <span class="nf">pairwise_interactions</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computation of the net forces resulting from pairwise interactions.&quot;&quot;&quot;</span>
    <span class="c1"># --&gt; Number of particles.</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># --&gt; Gram matrix.</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">X</span> <span class="o">@</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span>
    
    <span class="c1"># --&gt; Squared pairwise distances.</span>
    <span class="n">diag</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ii-&gt;i&#39;</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>
    <span class="n">d2</span> <span class="o">+=</span> <span class="n">diag</span> <span class="o">+</span> <span class="n">diag</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    
    <span class="c1"># --&gt; Prevent division by zero.</span>
    <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ii-&gt;i&#39;</span><span class="p">,</span> <span class="n">d2</span><span class="p">)[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="c1"># --&gt; Net forces.</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">d2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">**-</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">F</span>

<span class="k">def</span> <span class="nf">nbody</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ndim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Right-hand side function for the N-Body simulation.&quot;&quot;&quot;</span>
    <span class="c1"># --&gt; Number of particles.</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ndim</span><span class="p">)</span>
    
    <span class="c1"># --&gt; Initialize output vector.</span>
    <span class="n">du</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    
    <span class="c1"># --&gt; Extract the positions and velocities.</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:</span><span class="n">ndim</span><span class="o">*</span><span class="n">n</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="n">ndim</span><span class="o">*</span><span class="n">n</span><span class="p">:]</span>
    
    <span class="c1"># --&gt; Compute the acceleration.</span>
    <span class="n">ddx</span> <span class="o">=</span> <span class="n">pairwise_interactions</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span>

    <span class="c1"># --&gt; Return the time-derivatives for the ODE solver.</span>
    <span class="n">du</span><span class="p">[:</span><span class="n">ndim</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span>
    <span class="n">du</span><span class="p">[</span><span class="n">ndim</span><span class="o">*</span><span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ddx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
       
    <span class="k">return</span> <span class="n">du</span>
    
<span class="k">def</span> <span class="nf">simulation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    
    <span class="c1"># --&gt; Number of dimensions/Number of particles.</span>
    <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">dx</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># --&gt; Initial condition for the simulation.</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">dx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
    
    <span class="c1"># --&gt; Parameters for the ODE solver.</span>
    <span class="n">tspan</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">t_eval</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;DOP853&quot;</span>
    <span class="n">atol</span> <span class="o">=</span> <span class="n">rtol</span> <span class="o">=</span> <span class="mf">1e-13</span>
    
    <span class="c1"># --&gt; Run the simulation.</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span> <span class="p">:</span> <span class="n">nbody</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ndim</span><span class="p">),</span>
        <span class="n">tspan</span><span class="p">,</span>
        <span class="n">u</span><span class="p">,</span>
        <span class="n">t_eval</span><span class="o">=</span><span class="n">t_eval</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
        <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span>
    <span class="p">)</span>
    
    <span class="c1"># --&gt; Extract the positions and velocities of the n particles.</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][:</span><span class="n">n</span><span class="o">*</span><span class="n">ndim</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">n</span><span class="o">*</span><span class="n">ndim</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">dx</span>
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">simulation</span></code> takes as input:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">x</span></code> : Initial positions of the particles as a numpy array of size <code class="docutils literal notranslate"><span class="pre">n</span></code> by <code class="docutils literal notranslate"><span class="pre">ndim</span></code> with <code class="docutils literal notranslate"><span class="pre">n</span></code> the number of particles and <code class="docutils literal notranslate"><span class="pre">ndim</span></code> the dimension of the space considered.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dx</span></code> : Initial velocities of the particles as a numpy array of size <code class="docutils literal notranslate"><span class="pre">n</span></code> by <code class="docutils literal notranslate"><span class="pre">ndim</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">t</span></code> : The time points at which we’d like to save the simulation (typically a <code class="docutils literal notranslate"><span class="pre">np.linspace</span></code>).</p></li>
</ul>
<p>It returns the positions and velocities of the particles over time as numpy arrays of size <code class="docutils literal notranslate"><span class="pre">(n,</span> <span class="pre">ndim,</span> <span class="pre">len(t))</span></code>.</p>
<p>The animation below shows the results of simulation a 4-Body problem with the following initial conditions</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{X}
=
\begin{bmatrix}
    0 &amp; 0 \\
    0 &amp; 1 \\
    1 &amp; 1 \\
    1 &amp; 0
\end{bmatrix}
\quad
\dot{\mathbf{X}}
=
\begin{bmatrix}
    1 &amp; 0 \\
    0 &amp; -1 \\
    -1 &amp; 0 \\
    0 &amp; 1
\end{bmatrix}.
\end{split}\]</div>
<p>The particles thus initially form a unit square and their initial velocities are arranged such that the evolution is time-periodic.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">RuntimeError</span><span class="g g-Whitespace">                              </span>Traceback (most recent call last)
<span class="nn">Input In [4],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">HTML</span><span class="p">(</span><span class="n">anim</span><span class="o">.</span><span class="n">to_html5_video</span><span class="p">())</span>

<span class="nn">File ~/anaconda3/lib/python3.9/site-packages/matplotlib/animation.py:1266,</span> in <span class="ni">Animation.to_html5_video</span><span class="nt">(self, embed_limit)</span>
<span class="g g-Whitespace">   </span><span class="mi">1263</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;temp.m4v&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1264</span> <span class="c1"># We create a writer manually so that we can get the</span>
<span class="g g-Whitespace">   </span><span class="mi">1265</span> <span class="c1"># appropriate size for the tag</span>
<span class="ne">-&gt; </span><span class="mi">1266</span> <span class="n">Writer</span> <span class="o">=</span> <span class="n">writers</span><span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;animation.writer&#39;</span><span class="p">]]</span>
<span class="g g-Whitespace">   </span><span class="mi">1267</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="n">codec</span><span class="o">=</span><span class="s1">&#39;h264&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1268</span>                 <span class="n">bitrate</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;animation.bitrate&#39;</span><span class="p">],</span>
<span class="g g-Whitespace">   </span><span class="mi">1269</span>                 <span class="n">fps</span><span class="o">=</span><span class="mf">1000.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1270</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">)</span>

<span class="nn">File ~/anaconda3/lib/python3.9/site-packages/matplotlib/animation.py:151,</span> in <span class="ni">MovieWriterRegistry.__getitem__</span><span class="nt">(self, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">149</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_available</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">150</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registered</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">151</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requested MovieWriter (</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">) not available&quot;</span><span class="p">)</span>

<span class="ne">RuntimeError</span>: Requested MovieWriter (ffmpeg) not available
</pre></div>
</div>
</div>
</div>
<p>The code is now yours to play with!
You can consider any initial arrangement of particles you’d like.
Note however that, since we implemented a <strong>particle-particle method</strong>, the computation rapidly gets extremely expensive as you increase the number of particles.
You can try to see how many you can simulate in a reasonnable time on your own laptop.</p>
<section id="project-ideas-to-go-further">
<h2>Project ideas to go further<a class="headerlink" href="#project-ideas-to-go-further" title="Permalink to this headline">#</a></h2>
<p>The code we’ve implemented is fairly simple and can be used as the skeleton for more advanced simulations.
Whether you are a student keen on taking challenges or a teacher looking for project ideas for your classes, here is a non-exhaustive list of how you build upon this code :</p>
<ul class="simple">
<li><p>At the begining, we’ve made the assumptions that all particles had unit mass and we set the gravitational constant to <span class="math notranslate nohighlight">\(G = 1\)</span>.
This was made out of necessity to focus on the core of the solver.
You can however easily change this and add support for particles with different masses and set <span class="math notranslate nohighlight">\(G\)</span> to whatever value you like in your numerical universe.</p></li>
<li><p>The gravitational potential becomes singular as the distance <span class="math notranslate nohighlight">\(r\)</span> between two particles goes to zero.
This forces the time-stepper to take increasingly smaller time steps and massively increases the computational time.
If two particles happen to collide, it might even cause the whole simulation to blow up.
Different techniques have been proposed in the literature to remedy this problem.</p></li>
<li><p>N-Body simulations do not have to be restricted to astrophysical situations.
Other potentials can be considered.
A good project would be to implement a similar code for the <a class="reference external" href="https://en.wikipedia.org/wiki/Lennard-Jones_potential">Lennard-Jones potential</a>.
It is considered an archetype model for simple yet realistic intermolecular interactions.
This would be a good starting project for students interested in <a class="reference external" href="https://en.wikipedia.org/wiki/Molecular_dynamics">Molecular Dynamics</a>.</p></li>
</ul>
<p>For more advanced project ideas, you can also look into other methods than the particle-particle one.
These other methods are typically used when you consider an enormous number of particles for which the particle-particle method yields intractable computations.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Physics/NBody"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="vectorized.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Vectorized implementation</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../../Maths/Overview.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Applications in Maths</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Jean-Christophe Loiseau<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>